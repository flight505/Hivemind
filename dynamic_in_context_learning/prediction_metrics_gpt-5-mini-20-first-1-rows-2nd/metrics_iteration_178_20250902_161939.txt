PREDICTIVE METRICS - ITERATION 178
============================================================

Executive summary — immediate takeaways & top priorities (0–72h)

What happened (short)
- Three brittle n==1 failure modes are now confirmed:
  1) Single‑channel dominance (Passenger 0216_01): VRDeck extreme → unbounded per_feature_logit → FP.
  2) Cryo / all‑zero shortfall (Passenger 0219_01): CryoSleep=True + all spends=0 → FN (model under‑predicted).
  3) Infant / age‑zero all‑zero shortfall (Passenger 0220_02 — new): Age==0 (or imputed 0) + all spends=0 → FN (model relied on spend features, under‑weighed age/child signal).
- Common root causes:
  - n==1 vulnerability: no cohort averaging and calibrator underestimates uncertainty for small N slices.
  - Missing pre‑imputation slice detectors: infant_allzero, cryo_allzero and other fragility flags were absent or not used.
  - Over‑reliance on spend features; no caps/dampening allowed single channels or zero‑spend signatures to dominate.
  - Calibrator not heteroskedastic and missing topN / fragility conditioning (under‑inflated SE for brittle slices).
  - Imputation provenance not persisted → age imputed-to-0 indistinguishable from real infants.
- Top immediate priorities
  1) Emergency gating hotfix: treat records with infant_allzero_flag OR cryo_allzero_flag OR single_channel_dominant_flag OR multi_channel_outlier_flag OR any per_channel_implausible_flag OR imputed_count ≥ 1 as fragile → route to priority_audit if n_batch == 1 unless strict concordance + calibrated uncertainty tests pass.
  2) Compute pre‑imputation detectors including infant_allzero_flag (Age_raw ≤ 1 AND sum_raw_spends == 0), age_imputed_flag, cryo_allzero_flag, per_channel percentiles/z‑scores, multi_channel_outlier_flag, channel_entropy, missingness_signature.
  3) Apply per_feature logit caps and dominance dampening and add explicit contributions from age buckets to calibrator input.
  4) Upgrade calibrator to heteroskedastic quantile calibration conditioned on topN features + fragility flags + age_bucket; enforce SE floors for n==1 fragiles (including infants).
  5) Persist raw Age and imputation provenance and include 0220_02 in canary list.

Concise answers to the six operational questions (batch accuracy focus)

1) Which specific patterns caused the error?
- 0220_02 (FN): Age==0 (likely infant or imputed) + all channel spends == 0. The model relied on zero‑spend signals (histor negative association) and underweighted the protective effect of being an infant or the associated cluster (e.g., travel groups/family). Age imputation provenance missing or unflagged made Age==0 indistinguishable from true infants.

2) How should decision rules be modified?
- Add infant_allzero_flag (pre‑imputation): Age_raw ≤ 1 OR age_imputed_to_zero AND sum_raw_spends == 0 → fragile.
- If n_batch == 1 and fragile_flag set → route to priority_audit unless ALL pass:
  - GLM_fallback agrees (|p_model − p_glm| ≤ δ),
  - ensemble agreement high,
  - pooled_prior_tau ≥ τ_high_slice AND N_slice ≥ N_min_slice,
  - se_combined ≤ SE_accept_slice AND quantile_width ≤ QW_accept_slice.
- When auto‑deciding is allowed for infant_allzero records: dampen spends logit contributions and inflate variance.

3) New transport‑pattern insights?
- Infants/newborns (Age == 0 or <=1) often have zero spends but different survival characteristics than adults (higher survival rate in some settings); spends==0 is not always a negative predictor.
- Age and imputation provenance are critical discriminators; treating Age==0 as a pure signal of low spend rather than a demographic increases FN risk.
- These patterns are brittle in small‑N batches — cohort smoothing or heteroskedastic calibration by age slice required.

4) How should confidence be recalibrated?
- Use heteroskedastic quantile calibrator conditioned on topN inputs + flags including infant_allzero_flag and age_bucket.
- Add κ_infant to variance model (inflate variance when infant_allzero present). Enforce SE floor (start 0.65–0.75) for n==1 infant or cryo fragiles.

5) What adjustments are needed for batch consistency?
- Compute batch_frac_fragile including infant_allzero. If batch_frac_fragile ≥ BATCH_FRAGILE_THRESHOLD → hold batch for audit or require stricter gating.
- Stricter rules for n==1 and small batches — require GLM fallback concordance + narrow quantiles + adequate pooled prior.

6) How can the metrics be improved for edge cases like this?
- Persist raw Age and imputation provenance, add infant_allzero and cryo_allzero detectors, per_feature_logit caps/topK dampening, heteroskedastic calibrator, GLM_fallback for interpretable checks. Track slice‑level FP/FN for these new slices and upweight for calibrator training.

Complete updated predictive metrics report — actionable components (optimized for batch prediction accuracy)

A. Immediate emergency actions (0–6h)
- Emergency gating hotfix:
  - If n_batch == 1 AND (single_channel_dominant_flag OR multi_channel_outlier_flag OR cryo_allzero_flag OR infant_allzero_flag OR any per_channel_implausible_flag OR missing_homeplanet_flag OR missing_destination_flag OR imputed_count ≥ 1 OR novelty_high_flag) → route to priority_audit.
  - Add canaries: 0210_01, 0211_03, 0212_01, 0212_02, 0213_01, 0216_01, 0219_01, 0220_02 to canary list.
  - For any per_channel_implausible_flag or topN flag: downweight logits (×0.5–0.75), inflate variance immediately.
- Persist provenance for canaries/fragiles: raw per_channel spends (NaNs preserved), Age_raw + imputation method + imputed_age_flag, per_feature_logit_contributions, caps_triggered.
- Emergency SE floor: n==1 & fragile_topN/cryo_allzero/infant_allzero → se_floor = 0.65–0.75 (start 0.70).

B. Flag & feature definitions (compute pre‑imputation where possible)
- Age_imputed_flag: true if Age raw missing and imputed.
- is_infant_candidate: Age_raw ≤ AGE_INFANT_THRESHOLD OR Age_imputed_flag (AGE_INFANT_THRESHOLD start = 1).
- infant_allzero_flag: is_infant_candidate == True AND sum_raw_spends == 0 (ε tolerance).
  - Rationale: infants frequently have zero spends but different outcome distributions.
- cryo_allzero_flag: CryoSleep == True AND sum_raw_spends == 0.
- single_channel_dominant_flag: top1_share_raw ≥ 0.60.
- high_top1_abs_flag: top1_value_raw ≥ TOP1_SUSPICIOUS_ABS (start 700).
- multi_channel_outlier_flag and per_channel_implausible_flag same as prior spec.
- channel_entropy, missingness_signature: retained.

C. Feature engineering updates (v→v+1)
- Persist raw Age and imputation provenance; compute age_bucket (0, 1–12, 13–25, 26–55, 56+).
- New features:
  - infant_allzero_flag (boolean), age_imputed_flag, age_bucket_onehot, age_spend_interaction (age_bucket × sum_spend), top1/top2 percentiles, top1_top2_ratio, channel_entropy, topN_share_sum.
  - winsorized_spend[channel] at per‑channel caps.
  - per_feature_logit_contribution_raw and corrected (after caps/dampening).
- Keep raw data for calibrator and auditing.

D. Channel‑aware thresholds & caps
- Per‑channel percentiles / zscore detectors as before.
- Age threshold additions:
  - AGE_INFANT_THRESHOLD = 1 (Age ≤ 1 considered infant candidate).
- Recompute channel thresholds monthly on raw pre‑imputation data.

E. Per‑feature logit caps & dominance dampening
- Enforce per_feature_logit_cap (CAP_PER_CHANNEL_LOGIT base = 1.0; sweepable).
- Dominance dampening:
  - If single_channel_dominant_flag: scale top1_value by α_dom_channel (α_dom default 0.6; VRDeck 0.5).
  - If infant_allzero_flag: scale spend contributions by α_infant_spend (default 0.5) and increase age contribution weight.
  - Add logit_topK_sum_cap: cap sum of top3 per_feature_logits to LOGIT_TOPK_CAP = 1.6.
- Record caps triggered and dampening factors.

F. Variance / SE model enhancements (heteroskedastic)
- var_combined = var_base + κ_top1_high*I(top1_high) + κ_multi_high*multi_channel_count + κ_cryo*I(cryo_allzero) + κ_infant*I(infant_allzero) + κ_impute*imputed_count + κ_missing*missingness_score.
  - Example start values: κ_top1_high = 0.50; κ_multi_high = 0.45 per high channel; κ_cryo = 0.60; κ_infant = 0.50; κ_impute = 0.20.
- se_combined = sqrt(max(var_combined, se_floor(context)^2)).
- SE floors:
  - n==1 & fragile_topN OR cryo_allzero OR infant_allzero → se_floor = 0.70.
  - n>1 but batch_frac_fragile > small threshold → smaller elevated se_floor.

G. Decision‑gating (pattern‑aware + batch/cohort aware)
- fragile_flag_vX = union of infant_allzero_flag, cryo_allzero_flag, missing_homeplanet_flag, missing_destination_flag, single_channel_dominant_flag, multi_channel_outlier_flag, per_channel_implausible_flag, high_top1_abs_flag, imputed_count ≥ 1, novelty_high_flag.
- batch_frac_fragile = #fragile_records_in_batch / batch_size.
  - If batch_frac_fragile ≥ BATCH_FRAGILE_THRESHOLD (start 5%) → route entire batch to priority_audit (or require stricter gating).
- n==1 fragile gating: allow auto decision ONLY if ALL pass:
  - pooled_prior_tau ≥ τ_high_slice AND N_slice ≥ N_min_slice,
  - GLM_fallback_agrees (|p_model − p_glm| ≤ δ),
  - ensemble_agreement ≥ A_high,
  - se_combined ≤ SE_accept_slice AND (p90 − p10) ≤ QW_accept_slice.
  - Otherwise route to priority_audit.
- For infant_allzero_flag & cryo_allzero_flag: default route to priority_audit unless GLM+ensemble concordant AND se_combined small.

H. Calibrator & GLM_fallback retrain plan
- Calibrator:
  - Heteroskedastic quantile calibrator (outputs p10/p50/p90 + variance).
  - Inputs: raw_model_logit, per_feature_logit_contributions, fragility_flags (infant_allzero, cryo_allzero, topN flags), top1/top2 percentiles, multi_channel_count, channel_entropy, age_bucket, age_imputed_flag, missingness_signature.
  - Loss: quantile pinball (p10/p90), ECE regularizer, Brier for p50.
  - Upweight fragile and infant_allzero examples ×8–15 to avoid under‑confidence for these slices.
- GLM_fallback:
  - ElasticNet logistic on winsorized log1p channel features + Age_bucket + CryoSleep + Cabin_deck indicators + age_spend_interaction features + missingness signature.
  - Use as concordance check before auto decisions.
- Training:
  - Rolling window 18–36 months, CV stratified by fragile slices and age_bucket.
  - Shadow run 14–28 days for thresholds.

I. Mixture priors & cluster detection (slice‑aware)
- For brittle slices (infant_allzero, cryo_allzero, top1_high, multi_channel_high), cluster on demographics, raw_spend_vector, missingness_signature, cabin_deck.
- Compute cluster priors μ_cluster, N_cluster; blend priors by cluster membership probability.
- For infants, create child clusters vs. infant-in-family clusters (presence of other cabin mates with adults).

J. Monitoring, metrics & alerts (batch‑focused)
- New slice KPIs:
  - infant_allzero_FN_rate & FP_rate
  - cryo_allzero_FN_rate & FP_rate
  - top1_channel_FP_rate & FN_rate per channel
  - multi_channel_outlier_FP_rate & FN_rate
  - n==1_auto_accept_rate, n==1_fragile_auto_accept_rate
  - batch_frac_fragile, batch_hold_rate
- Alerts:
  - Any canary auto_accepted/rejected → immediate page.
  - infant_allzero_FN rise > baseline + X% over 24h → page.
  - batch_frac_fragile ≥ threshold → hold batch + page.
- Dashboards:
  - Per‑record provenance for canaries and fragiles (raw vs winsorized, per_feature_logits, calibrator outputs, gating_decision).

K. CI unit tests & validation (fragile & topN)
- Unit tests:
  - Pre‑imputation flags computed correctly (including infant_allzero_flag and age_imputed_flag).
  - infant_allzero_flag triggers for Age_raw ≤ 1 & sum_spends == 0.
  - cryo_allzero_flag triggers when CryoSleep==True & sum_raw_spend==0.
  - se_combined respects se_floor for n==1 & infant/cryo/topN cases.
  - Per_feature logit caps & dominance dampening enforced.
  - batch_frac_fragile ≥ threshold disables auto_decisions.
  - Canaries (incl. 0219_01, 0220_02) must not be auto_accepted/rejected while emergency gating active.
- Regression tests:
  - Global ECE / AUC / Brier degrade less than tolerances when gating enabled.
  - Slice-level FN_rate reductions for infant_allzero and cryo_allzero slices; FP reductions for top1_channel slices.
- Synthetic stress tests:
  - Inject Age==0 + all spends == 0 (infant_allzero) in n==1 and small batch contexts.
  - Single extreme channel injections (e.g., VRDeck > 1500) in n==1 contexts.
  - Cryo all‑zero injection: CryoSleep=True & spends=0 must route to audit or be correctly predicted by GLM+ensemble.

L. Operational actions & timeline (0–72h)
1) Immediate (0–6h)
   - Deploy emergency gating: n==1 fragiles include infant_allzero_flag; hold canaries (0216_01, 0219_01, 0220_02).
   - Persist provenance for canaries/fragiles; surface powers/flags in logs.
   - Expose per_feature_logits, caps_triggered, calibrator outputs in logs.
2) Short‑term (6–24h)
   - Implement per‑channel percentile & zscore detectors, cryo_allzero_flag, infant_allzero_flag, multi_channel_count; lightweight GLM_fallback; compute batch_frac_fragile and instrument dashboards; collect labels for flagged cases.
   - Shadow run to estimate audit volume and tune thresholds.
3) Mid‑term (24–72h)
   - Retrain heteroskedastic quantile calibrator and GLM_fallback with upweighted fragile slices; run extended shadow run (14–28 days).
   - Implement channel‑specific caps & dominance dampening; deploy mixture priors for brittle slices.

M. Per‑record provenance to log (minimum)
- Raw per_channel spends (NaNs preserved) + per_channel_imputed_flags + imputation_method + source_date.
- Raw Age + age_imputed_flag + age_imputation_method + Age_bucket.
- Demographics raw + missing flags: CryoSleep, missing_homeplanet_flag, missing_destination_flag, VIP.
- Transforms & flags: winsorized_spend[channel], top1/top2/top3_channel, top1_value_raw, top1_share_raw, top1_channel_pctile, top1_channel_zscore, multi_channel_count, channel_entropy, cryo_allzero_flag, infant_allzero_flag, high_top1_abs_flag, per_channel_implausible_flags, single_channel_dominant_flag, missingness_signature, cluster_id.
- Model internals: per_feature_logit_contributions (raw & capped), per_feature_logit_caps_triggered, pooled_prior_snapshot_id, μ_slice/μ_cluster, τ_slice_blend.
- Variances: var_components, var_combined, se_combined.
- Decision meta: GLM_fallback_probs, GLM_fallback_agreement_flag, ensemble_probs, ensemble_agreement, p10/p50/p90, quantile_width, gating_reasons, routing_decision, scorer_version.

N. Initial hyperparameters (start values; sweepable)
- AGE_INFANT_THRESHOLD = 1 (Age ≤ 1 → infant candidate)
- PCTILE_TOP1_FLAG = 99.0
- PCTILE_MULTI_FLAG = 95.0
- MULTI_CHANNEL_COUNT_MIN = 2
- Z_TOP1_FLAG = 3.0
- TOP1_SUSPICIOUS_ABS = 700 (global)
- VRDeck_absolute_cap = 1500; channel_abs_caps = min(channel_99.5pct, absolute_cap[channel])
- IMPLAUSIBLE_SUM_THRESHOLD = 1000
- SE floor for n==1 fragiles = 0.70
- α_dom_channel default = 0.6; α_dom_vrdeck = 0.5; α_infant_spend = 0.5
- β_multi = 0.6
- CAP_PER_CHANNEL_LOGIT = 1.0; LOGIT_TOPK_SUM_CAP = 1.6
- κ_top1_high = 0.50; κ_multi_high_per_channel = 0.45; κ_cryo = 0.60; κ_infant = 0.50; κ_impute = 0.20
- BATCH_FRAGILE_THRESHOLD = 0.05
- N_min_slice = 60; τ_high_slice = 0.95
- δ_slice (GLM disagreement tolerance) = 0.05
- A_high (ensemble agreement) = 0.995
- QW_accept_slice (quantile width) = 0.12

O. CI canaries & expected behavior
- Canary list: 0210_01, 0211_03, 0212_01, 0212_02, 0213_01, 0216_01, 0219_01, 0220_02.
- Expected route: priority_audit while emergency gating active.
- CI asserts: canaries not auto_accepted/rejected; raw provenance preserved.

P. Gating pseudocode (pattern‑aware, batch focused)
- For each batch B:
  - Compute batch_frac_fragile = count(r in B where fragile_flag_vX)/|B|
  - If batch_frac_fragile ≥ BATCH_FRAGILE_THRESHOLD: route all r in B -> priority_audit; continue
  - For each r in B:
      compute pre‑imputation flags (including infant_allzero, cryo_allzero), top1/top2/top3, multi_channel_count
      set fragile_flag_vX = union of flags above
      If n_batch == 1 and fragile_flag_vX:
         If pooled_prior_tau ≥ τ_high_slice AND N_slice ≥ N_min_slice AND GLM_fallback_agrees AND ensemble_agreement ≥ A_high AND se_combined ≤ SE_accept_slice AND (p90 − p10) ≤ QW_accept_slice:
             allow auto_decision
         Else:
             route r -> priority_audit
         continue
      If per_channel_implausible_flag OR top1_channel_pctile_flag OR multi_channel_outlier_flag OR cryo_allzero_flag OR infant_allzero_flag:
         apply dominance dampening and per_feature_logit_caps
         If GLM+ensemble concordant AND se_combined small -> allow auto_decision
         Else route -> priority_audit
      If missing_homeplanet_flag OR missing_destination_flag:
         route r -> data_quality_review + priority_audit

Q. Specific diagnosis — Passenger 0220_02 (chain of failure & root cause)
- Raw: HomePlanet=Earth, CryoSleep=False, Cabin=G/37/P, Destination=TRAPPIST-1e, Age=0.0, VIP=False, RoomService=0.0, FoodCourt=0.0, ShoppingMall=0.0, Spa=0.0, VRDeck=0.0.
- Failure chain:
  1) infant_allzero_flag not computed (absent or not used); Age==0 treated as numeric input, possibly imputed or not flagged.
  2) Model relied primarily on spends (all zero) and produced low score; Age signal underweighted and/or age imputed-provenance missing so model could not treat as infant cluster.
  3) Calibrator lacked age/infant conditioning and had narrow p10/p90 for this region → under‑estimated uncertainty.
  4) n==1 gating allowed auto decision → FN accepted.
- Immediate mitigations that would have prevented this FN:
  - infant_allzero_flag computed pre‑imputation → by default route to priority_audit or require GLM_fallback agreement.
  - Age_imputed_flag persisted; if age imputed to zero treat as fragile.
  - Upweight infant_allzero slice in calibrator and GLM training.
  - Mixture priors for infant clusters to avoid extrapolation failures.

R. How these changes reduce batch errors (short)
- Pre‑imputation fragility flags catch brittle patterns (infant_allzero, cryo_allzero, single_channel) before transforms hide them.
- Per_feature logit caps and topK dampening limit dominance by any single channel and reduce FPs like extreme VRDeck.
- Heteroskedastic calibrator + SE floors give conservative uncertainty for n==1 and fragile cases, reducing both FPs and FNs due to overconfidence.
- GLM fallback + ensemble consistency checks provide an interpretable safety net and reduce mistaken auto decisions.

S. Tradeoffs & operational notes
- Expect initial audit volume spike — tune AGE_INFANT_THRESHOLD and PCTILE_MULTI_FLAG and infant routing rule to balance throughput.
- Slight increase in latency and complexity; but far fewer high‑impact FPs and FNs in small batches.
- Global metrics may shift; prioritize slice‑level FN/FP reductions and batch accuracy.

T. Next steps / recommended sequencing
- Immediate: Deploy emergency gating (include infant_allzero_flag + cryo_allzero_flag + per‑channel percentile/zscore detection + single_channel_abs guards + provenance persistence) and hold canaries.
- Short term: Implement pre‑imputation detectors, infant_allzero_flag, lightweight GLM_fallback, logs and dashboards; run shadow tests for audit volume tuning.
- Mid term: Retrain heteroskedastic calibrator + GLM_fallback with upweighted fragile slices; implement per_feature caps/dampening and mixture priors; run extended shadow and finalize deployment.

Runnable checklist (concrete)
- Do not auto‑accept any n==1 record where:
  - infant_allzero_flag is True OR
  - cryo_allzero_flag is True OR
  - max_channel_raw ≥ channel_abs_cap_high OR
  - top1_channel_pctile_flag OR
  - multi_channel_outlier_flag OR
  - imputed_count ≥ 1 OR
  - missing_homeplanet_flag OR missing_destination_flag.
- Ensure calibrator input pipeline includes infant_allzero_flag, age_bucket, age_imputed_flag and topN features.
- Add unit test: Age_raw == 0 & all spends == 0 & n==1 -> route to audit (unless GLM+ensemble & se checks pass).
- Add synthetic tests: Age==0 + spends=0 must route / be predicted correctly by GLM+ensemble; VRDeck > 1500 → route / dampen.

Would you like me to:
- produce the emergency gating implementation now (runnable code + unit tests + CI patch) to immediately block canaries and n==1 fragiles (including 0213_01, 0216_01, 0219_01, 0220_02), or
- produce the full retraining pipeline spec (heteroskedastic quantile calibrator + GLM_fallback + mixture priors), hyperparameter sweep matrix, and shadow‑run dashboard spec for the 24–72h plan?

Recommendation: Push the hotfix gating (include infant_allzero_flag + cryo_allzero_flag + per‑channel percentile/zscore detection + single_channel_abs guards + provenance persistence) immediately to stop repeat FNs like 0220_02, then run the calibrator/GLM_fallback retrain in shadow. I can deliver the runnable gating code and unit tests within the hour if you want immediate mitigation.

============================================================